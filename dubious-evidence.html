<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Dubious evidence - Counterexamples in Type Systems</title>
        
        


        <!-- Custom HTML head -->
        <!-- KaTeX stylesheet -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">

<style>
pre[data-codetab=hide] { display: none; }
pre[data-codetab] { margin-top: 0 }
.error { color: #f00; }
.codetab-bar button {
  background-color: inherit;
  border: none;
  cursor: pointer;
}
.codetab-bar button:hover {
  background-color: #ddd;
}
.codetab-bar button[data-codetab=show] {
  background-color: #ccc;
}
</style>

<script>
function langName(node) {
  let lang = node.querySelector('code[class^="language-"]');
  if (lang) lang = lang.className.match(/language-(\w+)/)[1];
  lang = lang ? lang : "code";
  lang = lang.replace(/^\w/, s => s.toUpperCase());
  lang = {Ocaml:"OCaml","_rust":"Rust","Sml":"Standard ML","Typescript":"TypeScript","Csharp":"C#"}[lang] || lang;
  return lang;
}
function insertCodeTabs() {
  while (true) {
    let code = document.querySelector('pre:not([data-codetab])');
    if (!code) return;
    let bar = document.createElement("DIV");
    bar.classList.add('codetab-bar');
    let tabs = [], buttons = [];
    while (code && code.nodeName == "PRE") {
      let button = document.createElement('BUTTON');
      button.innerHTML = langName(code);
      tabs.push(code);
      buttons.push(button);
      bar.appendChild(button);
      code = code.nextElementSibling;
    }
    tabs[0].parentNode.insertBefore(bar, tabs[0]);
    let select = function(t,b) {
      tabs.forEach(t => t.dataset.codetab="hide");
      buttons.forEach(b => b.dataset.codetab="hide");
      t.dataset.codetab = "show";
      b.dataset.codetab = "show";
    };
    for (var i = 0; i < tabs.length; i++) {
      let ix = i;
      buttons[ix].addEventListener('click', ev => select(tabs[ix], buttons[ix]));
    }
    select(tabs[0], buttons[0]);
  }
}
document.addEventListener('DOMContentLoaded', insertCodeTabs);
</script>

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 450) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="title.html">Counterexamples in Type Systems</a></li><li class="chapter-item expanded affix "><a href="intro.html">Introduction</a></li><li class="chapter-item expanded affix "><a href="glossary.html">Index and Glossary</a></li><li class="chapter-item expanded "><a href="polymorphic-references.html"><strong aria-hidden="true">1.</strong> Polymorphic references</a></li><li class="chapter-item expanded "><a href="general-covariance.html"><strong aria-hidden="true">2.</strong> Covariant containers</a></li><li class="chapter-item expanded "><a href="incomplete-variance.html"><strong aria-hidden="true">3.</strong> Incomplete variance checking</a></li><li class="chapter-item expanded "><a href="under-construction.html"><strong aria-hidden="true">4.</strong> Objects under construction</a></li><li class="chapter-item expanded "><a href="currys-paradox.html"><strong aria-hidden="true">5.</strong> Curry's paradox</a></li><li class="chapter-item expanded "><a href="eventually-nothing.html"><strong aria-hidden="true">6.</strong> Eventually, nothing</a></li><li class="chapter-item expanded "><a href="dubious-evidence.html" class="active"><strong aria-hidden="true">7.</strong> Dubious evidence</a></li><li class="chapter-item expanded "><a href="anythings.html"><strong aria-hidden="true">8.</strong> Some kinds of Anything</a></li><li class="chapter-item expanded "><a href="anything-once.html"><strong aria-hidden="true">9.</strong> Any (single) thing</a></li><li class="chapter-item expanded "><a href="mutable-matching.html"><strong aria-hidden="true">10.</strong> Mutable matching</a></li><li class="chapter-item expanded "><a href="runtime-misinformation.html"><strong aria-hidden="true">11.</strong> Runtime type misinformation</a></li><li class="chapter-item expanded "><a href="overloading-polymorphism.html"><strong aria-hidden="true">12.</strong> Overloading and polymorphism</a></li><li class="chapter-item expanded "><a href="distinctness-injectivity.html"><strong aria-hidden="true">13.</strong> Distinctness I: Injectivity</a></li><li class="chapter-item expanded "><a href="distinctness-recursion.html"><strong aria-hidden="true">14.</strong> Distinctness II: Recursion</a></li><li class="chapter-item expanded "><a href="distinctness-options.html"><strong aria-hidden="true">15.</strong> Distinctness III: Options</a></li><li class="chapter-item expanded "><a href="subtyping-vs-inheritance.html"><strong aria-hidden="true">16.</strong> Subtyping vs. inheritance</a></li><li class="chapter-item expanded "><a href="selfishness.html"><strong aria-hidden="true">17.</strong> Selfishness</a></li><li class="chapter-item expanded "><a href="privacy-violation.html"><strong aria-hidden="true">18.</strong> Privacy violation</a></li><li class="chapter-item expanded "><a href="unstable-types.html"><strong aria-hidden="true">19.</strong> Unstable type expressions</a></li><li class="chapter-item expanded "><a href="avoidance.html"><strong aria-hidden="true">20.</strong> The avoidance problem</a></li><li class="chapter-item expanded "><a href="little-knowledge.html"><strong aria-hidden="true">21.</strong> A little knowledge...</a></li><li class="chapter-item expanded "><a href="underdetermined-recursion.html"><strong aria-hidden="true">22.</strong> Underdetermined recursion</a></li><li class="chapter-item expanded "><a href="overdetermined-recursion.html"><strong aria-hidden="true">23.</strong> Overdetermined recursion</a></li><li class="chapter-item expanded "><a href="scope-escape.html"><strong aria-hidden="true">24.</strong> Scope escape</a></li><li class="chapter-item expanded "><a href="false-pretenses.html"><strong aria-hidden="true">25.</strong> Under false pretenses</a></li><li class="chapter-item expanded "><a href="suspicious-subterms.html"><strong aria-hidden="true">26.</strong> Suspicious subterms</a></li><li class="chapter-item expanded "><a href="only-one-leibniz.html"><strong aria-hidden="true">27.</strong> There's only one Leibniz</a></li><li class="chapter-item expanded "><a href="intersecting-references.html"><strong aria-hidden="true">28.</strong> Intersecting references</a></li><li class="chapter-item expanded "><a href="polymorphic-union-refinement.html"><strong aria-hidden="true">29.</strong> Polymorphic union refinement</a></li><li class="chapter-item expanded "><a href="strict-positivity.html"><strong aria-hidden="true">30.</strong> Positivity, strict and otherwise</a></li><li class="chapter-item expanded "><a href="nearly-universal.html"><strong aria-hidden="true">31.</strong> Nearly-universal quantification</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Counterexamples in Type Systems</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        <a href="https://github.com/stedolan/counterexamples" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#dubious-evidence" id="dubious-evidence">Dubious evidence</a></h1>
<p><small><a href="glossary.html#empty-types">[empty-types]</a> <a href="glossary.html#equality">[equality]</a></small></p>
<p>While the <code>Empty</code> type of the previous counterexample has no values at
all, there are types whose emptiness depends on their parameters. The
canonical example is the equality type, expressible as a GADT in
Haskell or OCaml or as an inductive family in Coq or Agda (among
others):</p>
<pre><code class="language-ocaml">type (_, _) eq =
  Refl : ('a, 'a) eq
</code></pre>
<pre><code class="language-haskell">data Eq a b where
  Refl :: Eq a a
</code></pre>
<pre><code class="language-coq">Inductive eq {S : Set} : S -&gt; S -&gt; Prop :=
  Refl a : eq a a.
</code></pre>
<pre><code class="language-agda">data Eq {S : Set} : S -&gt; S -&gt; Set where
  refl : (a : S) -&gt; Eq a a
</code></pre>
<p>The type <code>(a, b) eq</code> witnesses equality: it is nonempty if <code>a</code> and <code>b</code>
are the same type, and empty if they are distinct. Values of type <code>(a, b) eq</code> constitute evidence that <code>a</code> and <code>b</code> are in fact the same, and
can be used e.g. to turn an <code>a</code> into a <code>b</code>.</p>
<p>For an arbitrary type <code>a</code>, we have no way of making an <code>(int, a) eq</code>:
for all we know <code>a</code> might be <code>string</code>. The only way to construct a
value of the <code>eq</code> type is using <code>Refl</code>, which demands the parameters
be equal.</p>
<p>In a pure, total language, the existence of an expression of type <code>(a, b) eq</code> is enough to conclude <code>a</code> and <code>b</code> are equal. But in a less pure
language, where evaluation might fail or loop, the mere existence of
an expression with the right type is not evidence enough: we need to
actually run it, to see that it does in fact yield <code>Refl</code>. Several
type systems have had soundness bugs where evidence of this sort is
trusted without being fully evaluated:</p>
<ul>
<li>
<p><strong>Null evidence</strong></p>
<p>In languages with <code>null</code>, types like <code>eq</code> contain <code>null</code>, and
unlike <code>Refl</code>, <code>null</code> implies nothing about its type
parameters. So, before making use of any evidence we need to
verify that the evidence isn't <code>null</code>.</p>
<p>The lack of such verification caused a soundness issue in Java and
Scala<sup class="footnote-reference"><a href="#amintate">1</a></sup> (using a type that provides evidence for
subtyping, rather than equality):</p>
<pre><code class="language-java">// Counterexample by Nada Amin and Ross Tate
class Unsound {
  static class Constrain&lt;A, B extends A&gt; {}
  static class Bind&lt;A&gt; {
    &lt;B extends A&gt;
    A upcast(Constrain&lt;A,B&gt; constrain, B b) {
      return b;
    }
  }
  static &lt;T,U&gt; U coerce(T t) {
    Constrain&lt;U,? super T&gt; constrain = null;
    Bind&lt;U&gt; bind = new Bind&lt;U&gt;();
    return bind.upcast(constrain, t);
  }
  public static void main(String[] args) {
    String zero = Unsound.&lt;Integer,String&gt;coerce(0);
  }
}
</code></pre>
<pre><code class="language-scala">// Counterexample by Nada Amin and Ross Tate
object unsoundMini {
  trait A { type L &gt;: Any}
  def upcast(a: A, x: Any): a.L = x
  val p: A { type L &lt;: Nothing } = null
  def coerce(x: Any): Nothing = upcast(p, x)
  coerce(&quot;Uh oh!&quot;)
}
</code></pre>
</li>
<li>
<p><strong>Self-justifying evidence</strong></p>
<p>Evidence <code>p : (int, a) eq</code> can be used to construct more evidence
that <code>int</code> and <code>a</code> are equal, by seeing that <code>p</code> is <code>Refl</code>,
therefore learning that <code>int</code> and <code>a</code> are equal, and using this
information to justify <code>Refl : (int, a) eq</code>.</p>
<p>OCaml<sup class="footnote-reference"><a href="#ocamlbug">2</a></sup> had a soundness issue in which it allowed this sort of
reasoning in a recursive definition of <code>p</code>, allowing <code>p</code> to be
used as evidence for itself:</p>
<pre><code class="language-ocaml">(* Counterexample by Stephen Dolan *)
type (_,_) eq = Refl : ('a, 'a) eq
let cast (type a) (type b) (Refl : (a, b) eq) (x : a) = (x : b)

let is_int (type a) =
  let rec (p : (int, a) eq) = match p with Refl -&gt; Refl in
  p

let bang =
  (* segfaults *)
  print_string (cast (is_int : (int, string) eq) 42)
</code></pre>
</li>
<li>
<p><strong>Out-of-order evidence</strong></p>
<p>When nontermination is possible, it is important to ensure that
the order in which evidence is used matches the evaluation
order. Otherwise, it is possible to write an expression that does
not terminate, but make use of it before it runs. Such forward references
caused a soundness issue in Scala<sup class="footnote-reference"><a href="#scalafwd">3</a></sup>:</p>
<pre><code class="language-scala">// Counterexample by Paolo G. Giarrusso
new {
  val a: String = (((1: Any): b.A): Nothing): String
  def loop(): Nothing = loop()
  val b: { type A &gt;: Any &lt;: Nothing } = loop()
}
</code></pre>
</li>
<li>
<p><strong>Time-travelling evidence</strong></p>
<p><em>Staged metaprogramming</em> allows a program to manipulate program
fragments, gluing together an output program from quoted
fragments of code. However, it is unsound to allow evidence
computed in the future by the generated output program to justify
computations now. This caused a soundness bug in Scala's
implementation of staged metaprogramming<sup class="footnote-reference"><a href="#scalastage">4</a></sup> and in
BER MetaOCaml<sup class="footnote-reference"><a href="#metaocamlbug">5</a></sup>:</p>
<pre><code class="language-scala">// Counterexample by Lionel Parreaux
import scala.quoted.staging._

given Toolbox = Toolbox.make(getClass.getClassLoader)
trait T { type A &gt;: Any &lt;: Nothing }

withQuoteContext { '{ (x: T) =&gt; ${ 42: x.A } } }
// crashes with java.lang.ClassCastException
</code></pre>
<pre><code class="language-ocaml">(* Counterexample by Jeremy Yallop *)
type _ t = T : string t

let f : type a. a t option code -&gt; a -&gt; unit code =
  fun c x -&gt; .&lt; match .~c with
  | None -&gt; ()
  | Some T -&gt; .~(print_endline x; .&lt;()&gt;.) &gt;.

let _ = f .&lt; None &gt;. 0
</code></pre>
</li>
</ul>
<div class="footnote-definition" id="amintate"><sup class="footnote-definition-label">1</sup>
<p><a href="http://io.livecode.ch/learn/namin/unsound/scala">Java and Scala’s Type Systems are Unsound</a> (OOPSLA '16)
Nada Amin and Ross Tate (2016)</p>
</div>
<div class="footnote-definition" id="ocamlbug"><sup class="footnote-definition-label">2</sup>
<p><a href="https://github.com/ocaml/ocaml/issues/7215">https://github.com/ocaml/ocaml/issues/7215</a> (2016)</p>
</div>
<div class="footnote-definition" id="scalafwd"><sup class="footnote-definition-label">3</sup>
<p><a href="https://github.com/lampepfl/dotty/issues/5854">https://github.com/lampepfl/dotty/issues/5854</a> (2019)</p>
</div>
<div class="footnote-definition" id="scalastage"><sup class="footnote-definition-label">4</sup>
<p><a href="https://github.com/lampepfl/dotty/issues/9353">https://github.com/lampepfl/dotty/issues/9353</a> (2020)</p>
</div>
<div class="footnote-definition" id="metaocamlbug"><sup class="footnote-definition-label">5</sup>
<p><a href="https://github.com/metaocaml/ber-metaocaml/blob/ber-n111/ber-metaocaml-111/test/tgadt.ml">https://github.com/metaocaml/ber-metaocaml/blob/ber-n111/ber-metaocaml-111/test/tgadt.ml</a> (2016)</p>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="eventually-nothing.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="anythings.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="eventually-nothing.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="anythings.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
